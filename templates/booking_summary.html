<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Booking Summary</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loader {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #E76268;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .success {
            font-size: 2.5rem;
            color: green;
            margin-top: 20px;
        }
    </style>
</head>

<body class="summary-page">
    {% include 'navbar.html' %}
    <div class="page-content">
        <div class="summary-container">
            <h1>üìã Booking Summary</h1>

            <div class="summary-box">
                <p><strong>From:</strong> {{ journey.departure_city }}</p>
                <p><strong>To:</strong> {{ journey.arrival_city }}</p>
                <p><strong>Date:</strong> {{ travel_date }}</p>
                <p><strong>Base Fare:</strong> ¬£{{ base_price }}</p>
                <p><strong>Seat Type:</strong> {{ seat.type_name }} (x{{ seat_multiplier }})</p>
                <p><strong>Discount:</strong> {{ discount_percent }}% (‚àí¬£{{ discount_amount }})</p>
                <p class="total"><strong>Total Price:</strong> ¬£{{ final_price }}</p>
            </div>

            <!-- Updated form with id -->
            <form id="bookingForm">
                <input type="hidden" name="journey_id" value="{{ journey_id }}">
                <input type="hidden" name="seat_type_id" value="{{ seat.id }}">
                <input type="hidden" name="travel_date" value="{{ travel_date }}">
                <input type="hidden" name="final_price" value="{{ final_price }}">
                <input type="hidden" name="slot_id" value="{{ slot_id }}"> <!-- ‚úÖ Add this -->
                <input type="hidden" name="seats_booked" value="{{ seats_booked }}"> <!-- ‚úÖ And this -->
                <button type="submit" class="btn-book">‚úÖ Confirm Booking</button>
            </form>

            <form id="payLaterForm">
                <input type="hidden" name="journey_id" value="{{ journey_id }}">
                <input type="hidden" name="seat_type_id" value="{{ seat.id }}">
                <input type="hidden" name="travel_date" value="{{ travel_date }}">
                <input type="hidden" name="final_price" value="{{ final_price }}">
                <input type="hidden" name="slot_id" value="{{ slot_id }}">
                <input type="hidden" name="seats_booked" value="{{ seats_booked }}">
                <button type="submit" class="btn-book" style="background:#f1c40f;">üïì Pay Later</button>
            </form>


            <a href="/booking" class="back-link">‚Üê Go Back</a>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loadingOverlay" class="overlay">
        <div class="loader"></div>
        <p>Sending receipt email...</p>
    </div>

    <!-- Success Screen -->
    <div id="successOverlay" class="overlay">
        <div class="success">‚úÖ</div>
        <p>Booking Confirmed!</p>
    </div>

    <script>
        document.getElementById('bookingForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            document.getElementById('loadingOverlay').style.display = 'flex';

            const form = e.target;
            const formData = new FormData(form);
            const payload = Object.fromEntries(formData.entries());

            const response = await fetch('/confirm-booking', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.success && result.redirect_url) {
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('successOverlay').style.display = 'flex';
                setTimeout(() => {
                    window.location.href = result.redirect_url;
                }, 2000);
            } else {
                alert("Something went wrong.");
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        });

        document.getElementById('payLaterForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);
            const payload = Object.fromEntries(formData.entries());
            payload.status = 'unpaid';

            const response = await fetch('/add-to-cart', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            if (result.success) {
                alert("Booking added to cart!");
                window.location.href = "/cart";
            } else {
                alert("Something went wrong.");
            }
        });
    </script>
</body>

</html>